/******************************************************************************
 *
 *   FILE
 *   ----
 *   bufferer.c
 *
 *   History
 *   -------
 *   2018-11-14   File created
 *
 *******************************************************************************
 *
 *   This file is generated by the 'acplt_builder' command
 *
 ******************************************************************************/

#ifndef OV_COMPILE_LIBRARY_sync
#define OV_COMPILE_LIBRARY_sync
#endif

#include "sync.h"
#include "sync_helper.h"

#include "PostSys.h"
#include "PostSys_helpers.h"
#include "libov/ov_macros.h"
#include "libov/ov_result.h"

OV_DLLFNCEXPORT void sync_bufferer_typemethod(OV_INSTPTR_ksbase_ComTask this) {
  /*
   *   local variables
   */
  OV_RESULT                result = OV_ERR_OK;
  OV_INSTPTR_sync_bufferer pinst = Ov_StaticPtrCast(sync_bufferer, this);
  OV_INSTPTR_PostSys_inbox pInb =
      Ov_SearchChildEx(ov_containment, pinst, "inbox", PostSys_inbox);
  if(!pInb) {
    ov_logfile_debug("sync_bufferer: no inbox");
    return;
  }

  OV_INSTPTR_PostSys_Message pMsg = NULL;
  OV_INSTPTR_PostSys_Message pMsgCpy = NULL;
  /*OV_INSTPTR_PostSys_MsgDelivery pMsgDelivery = NULL;*/
  OV_UINT waitingLen = pinst->v_msgsWaitingRes.veclen;
  OV_BOOL buffering = (pinst->v_status != BUFFERER_NOBUFFERING);

  if(buffering ? 1 : !waitingLen) {
    Ov_ForEachChildEx(ov_containment, pInb, pMsg, PostSys_Message) {
      if(!Ov_GetParent(sync_buffered, pMsg)) {
        if(buffering) {
          break;
        } else {
          if(pMsg->v_refMsgID) {
            for(OV_UINT i = 0; i < waitingLen; ++i) {
              if(ov_string_compare(pinst->v_msgsWaitingRes.value[i],
                                   pMsg->v_refMsgID) == OV_STRCMP_EQUAL) {
                ov_logfile_info("sync_bufferer: result to msg %s arrived",
                                pMsg->v_refMsgID);
                break;
              }
            }
          }
        }
      }
    }
    if(!pMsg)
      return;

    /* buffering MSG */
    OV_INSTPTR_sync_Buffer pbuf = &pinst->p_buffer;
    /* copy MSG to buffer */
    result = Ov_CreateIDedObject(PostSys_Message, pMsgCpy, pbuf, "Message");
    if(result) {
      ov_logfile_error("sync_bufferer: %s", ov_result_getresulttext(result));
      return;
    }
    result = PostSys_Message_copy(pMsgCpy, pMsg);
    if(Ov_Fail(result)) {
      ov_logfile_error("%u: %s: could not create copy of MSG", result,
                       ov_result_getresulttext(result));
      return;
    }
    Ov_Link(sync_buffered, pinst, pMsg);
    /* keeping track of msgs to send answer back */
    if(pMsg->v_refMsgID) {
      ov_logfile_info("sync_bufferer: answer msg with refid %s, body %s",
                      pMsg->v_refMsgID, pMsg->v_msgBody);
      OV_UINT i = 0;
      for(i = 0; i < pinst->v_msgsWaitingRes.veclen; ++i) {
        if(ov_string_compare(pinst->v_msgsWaitingRes.value[i],
                             pMsg->v_refMsgID) == OV_STRCMP_EQUAL) {
          ov_string_setvalue(&pinst->v_msgsWaitingRes.value[i], NULL);
          pinst->v_msgsWaitingRes.value[i] =
              pinst->v_msgsWaitingRes.value[waitingLen - 1];
          pinst->v_msgsWaitingRes.value[waitingLen - 1] = NULL;
          Ov_SetDynamicVectorLength(&pinst->v_msgsWaitingRes, waitingLen - 1,
                                    STRING);
          break;
        }
      }
      if(i == waitingLen) {
        ov_logfile_warning("sync_bufferer: msgRefId %s: was not expected",
                           pMsg->v_refMsgID);
      }
    } else {
      Ov_SetDynamicVectorLength(&pinst->v_msgsWaitingRes,
                                pinst->v_msgsWaitingRes.veclen + 1, STRING);

      ov_string_setvalue(
          &pinst->v_msgsWaitingRes.value[pinst->v_msgsWaitingRes.veclen - 1],
          pMsg->v_msgID);
    }
  }
  /* sending MSG */
  PostSys_node_typemethod(Ov_StaticPtrCast(ksbase_ComTask, pinst));
  return;
}
